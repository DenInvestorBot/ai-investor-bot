<...основной код, обрезан для краткости...>